# 3. 인터럽트의 원리

## 프로그램의 구조와 인터럽트
- 프로그램이 CPU에서 명령을 수행하려면 수행하려는 주소 영역이 메모리에 올라가 있어야 한다.
- 우리가 작성한 프로그램은 처음에 메인 함수에서 실행하여 다른 함수를 호출하면 CPU가 메인 함수의 코드를 수행하다가 다른 함수의 코드로 수행 위치를 이동하게 된다.
- 그러면 프로그램은 새로운 함수 위치로 점프해 그 함수를 실행하고 함수 수행이 완료 된 후에는 원래 호출했던 함수 위치로 돌아온다.
- 이때 다시 돌아와야 하는 지점을 스택에 저정한다.
- 인터럽트의 동작 원리도 이와 비슷하다.
- 프로그램 A가 CPU를 할당받고 명령을 수행하고 있는데 인터럽트가 발생하면 A는 현재 수행중인 명령의 위치를 저장한다.
- 그 후 운영체제 내부 코드인 **인터럽트 처리 루틴**으로 넘어가서 인터럽트를 처리하고 다시 돌아와 A의 이전 작업 지점부터 수행을 다시 이어간다.
- 인터럽트 때문에 CPU를 선점당한 위치를 저장하기 위해 커널에 저장한다.
- 운영체제는 현재 실행중인 모든 프로그램을 관리하기 위한 자료구조( PCB : Process Control Block )를 유지한다.
- PCB에는 인터럽트가 발생했을 때 그 프로그램이 어디까지 수행했는지를 저장하기 위한 영역이 존재한다.
  1. 프로그램 A가 수행중에 인터럽트가 발생
  2. 현재 지점을 PCB에 저장
  3. 인터럽트 처리 루틴으로 가서 일을 처리
  4. 끝나면 PCB에 프로그램 A의 저장된 주소를 복원 후 원래 하던 일을 재개.
  
  
## 컴퓨터 시스템의 작동 개요
- CPU는 현재 수행해야 할 메모리 주소의 명령을 있는 그대로 처리한다.
- CPU가 수행해야 할 메모리 주소를 담고 있는 레지스터를 **프로그램 카운터(PC)** 라고 한다.
- CPU는 매번 프로그램 카운터가 가리키는 메모리 영역의 명령을 처리하게 된다.
- 컴퓨터 시스템의 동작은 CPU 뿐만 아니라, 프로그램 수행 중에 디스크에서 파일을 읽어오기도 하고, 키보드로부터 입력을 받기도한다.
- CPU에서 명령을 수행하는 부분과 컴퓨터 외부와 입출력이 이루어지는 부분을 총체적으로 이해하기 위해서는 컴퓨터 시스템의 구성에 대해 넓은 이해가 필요하다.
- 컴퓨터 시스템을 구성하는 하드웨어는 CPU, 메모리, 입출력 장치, 이들 장치를 전담하는 작은 CPU(입출력 컨트롤러)와 메모리(로컬 버퍼)가 있다.
- CPU가 수행하는 명령에는 **일반 명령**과 **특권 명령**이 있다.
- 일반 명령은 메모리에서 자료를 읽어와서 CPU에서 계산하고 결과를 메모리에 쓰는 일련의 명령들을 말한다. ( 모든 프로그램이 수행 )
- 특권 명령은 보안이 필요한 명령으로 I/O장치, 타이머 등 각종 장치를 접근하는 명령이다.
- 컴퓨터 시스템은 특권 명령을 항상 운영 체제만이 수행할 수 있도록 제한한다.
- 사용자 프로그램이 일반 명령 외에 특권 명령의 수행이 필요한 경우에 운영체제에게 특권 명령의 대행을 요청한다. ( **시스템 콜** )
- 사용자 프로그램이 시스템 콜을 하게되면 운영체제는 사용자 프로그램의 코드가 아닌 자신의 커널 영역에 정의된 **시스템 콜 처리 코드**를 수행하게 된다.
- CPU는 프로그램 카운터가 가리키는 메모리 위치의 명령만 수행하기 때문에 주변 장치의 상태를 계속 파악할 수 없다.
- 주변 장치는 CPU의 도움이 필요할 때 인터럽트를 사용해 CPU에게 서비스를 요청하게 된다.


## 프로그램의 실행
- "프로그램이 실행되고 있다"는 의미는 컴퓨터 시스템 차원에서 두가지 중요한 의미가 있다.
- 1.디스크에 존재하던 실행 파일이 메모리에 적재됨을 의미한다. 2.프로그램이 CPU를 할당받고 기계 명령을 수행하고 있는 상태를 의미한다.
- 여러 프로그램이 CPU를 짧은 단위로 나눠 쓰고, 이들 프로그램이 메모리에 동시에 적재되어 있을 수 있으므로 여러 프로그램이 동시에 실행된다는 표현을 쓴다.
- 프로그램의 주소 공간 중 당장 CPU의 수행에 필요한 부분은 메모리에 올려놓고 그렇지 않은 부분은 디스크 중 메모리의 연장 공간으로 사용되는 스왑 영역에 놓는다.
- 프로세스의 주소 공간은 코드, 데이터, 스택으로 구성된다. 각 프로그램마다 이러한 주소 공간을 별도로 가지며 이런 주소 공간을 **가상 메모리**, **논리적 메모리**라고 부른다.
- 운영체제도 하나의 프로그램이므로 운영체제 커널 역시 코드, 데이터, 스택의 주소 공간을 가진다.
- 커널의 데이터 영역에는 각종 자원을 관리하기 위한 자료구조가 저장된다.
- 시스템 콜 등 커널 내의 함수를 호출하는 경우에는 커널의 주소 공간에 존재하는 커널 스택을 사용하게 된다.



출처 : 운영 체제와 정보기술의 원리 - 반효경